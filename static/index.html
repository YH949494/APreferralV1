<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Referral & Check-in</title><script src="https://telegram.org/js/telegram-web-app.js"></script><style>body{background-color:#f4f4f4;font-family:'Arial',sans-serif;padding:20px;color:#333;font-size:16px}h2,h3{text-align:left;font-weight:600}.section{background:#fff;padding:20px;margin:15px 0;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,.1)}button{background-color:#0088cc;color:#fff;padding:10px 20px;font-size:15px;border:none;border-radius:6px;cursor:pointer;font-family:inherit;margin:5px 0}button:hover{background-color:#006699}#referral-link,#checkin-result,#checkin-timer{margin-top:10px;font-size:15px}#leaderboard-output{margin-top:10px;font-family:'Courier New',monospace;white-space:pre-wrap;background:#f9f9f9;padding:15px;border-radius:8px;border:1px solid #ddd;font-size:13px;line-height:1.4;overflow-x:auto}#admin-panel{display:none;background:#fff4e6;border:1px solid #ffcc80}#admin-panel h3{color:#d17c00}.modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,.5);justify-content:center;align-items:center}.modal-content{background:#fff;padding:20px;border-radius:10px;text-align:center;width:300px}input[type=text],input[type=number]{width:90%;padding:10px;margin:8px 0;border-radius:6px;border:1px solid #ccc;font-size:14px}</style></head><body>
  <h2>🎯 Referral & Daily Check-in</h2>

<!-- COMMUNITY BUTTONS -->
<div style="display:flex; justify-content:space-between; align-items:center; margin-top:20px; gap:10px;">

  <!-- Left: Official Channel -->
  <a href="https://t.me/advantplayofficial" target="_blank"
     style="flex:1; text-align:center; text-decoration:none;
            background:#007bff; color:#fff; padding:10px 0;
            border-radius:8px; font-size:15px; font-weight:500;">
    📣 Official Channel
  </a>

  <!-- Right: Info Hub -->
  <button id="infoHubBtn"
          style="flex:1; padding:10px 0; border:none; border-radius:8px;
                 background:#007bff; color:#fff; font-size:15px; cursor:pointer;
                 font-weight:500;">
    ℹ️ Info Hub
  </button>

</div>

<!-- INFO HUB MODAL -->
<div id="infoHubModal"
     style="display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;
            background-color:rgba(0,0,0,0.5);">
  <div style="background:#fff;margin:8% auto;padding:20px;border-radius:12px;width:92%;
              max-width:400px;text-align:left;">
    <h2 style="margin-bottom:15px;">ℹ️ Info Hub</h2>

    <!-- TAB BUTTONS -->
    <div style="display:flex;gap:6px;margin-bottom:10px;">
      <button class="tab-btn active" data-tab="tab-event"
              style="flex:1;padding:8px 10px;border:none;border-radius:6px;background:#007bff;color:#fff;cursor:pointer;">
        🎉 Event
      </button>
      <button class="tab-btn" data-tab="tab-xp"
              style="flex:1;padding:8px 10px;border:none;border-radius:6px;background:#eaf4ff;color:#007bff;cursor:pointer;">
        ⭐ XP
      </button>
      <button class="tab-btn" data-tab="tab-vip"
              style="flex:1;padding:8px 10px;border:none;border-radius:6px;background:#eaf4ff;color:#007bff;cursor:pointer;">
        👑 VIP Tier 1
      </button>
    </div>

    <!-- TAB PANELS -->
    <div id="tab-event" class="tab-panel active" style="text-align:left;">
  <p style="margin-bottom:8px;"><b>🎉 AdvantPlay Community Lucky Draw</b></p>

  <ul style="margin:0 0 10px 0; padding:0; list-style:none; line-height:1.6;">
    <li>📅 1–31 Oct 2025</li>
    <li>🎁 iPhone 17 Pro · Apple Watch · AirPods and more</li>
    <li>🏆 Winners announced 7 Nov 2025</li>
  </ul>

  <a href="https://telegra.ph/AdvantPlay-Community-Lucky-Draw-09-22"
     target="_blank"
     style="display:block; margin-top:8px; width:fit-content;
            padding:8px 12px; background:#28a745; color:#fff;
            border-radius:6px; text-decoration:none; font-size:14px;">
    📜 View T&C
  </a>
</div>

    <div id="tab-xp" class="tab-panel" style="display:none; text-align:left;">
  <p style="margin-bottom:8px;"><b>How to Earn XP</b></p>

  <ul style="margin:0; padding:0; list-style:none; line-height:1.6;">
    <li>- Daily Check-in 20 XP</li>
    <li>- Streak bonus<br>
        <span style="margin-left:18px;">(7d 50 XP · 14d 150 XP · 28d 300 XP)</span>
    </li>
  </ul>

  <div style="height:10px;"></div>

  <ul style="margin:0; padding:0; list-style:none; line-height:1.6;">
    <li>- Referral 30 XP / member</li>
    <li>- 3 successful referrals 200 XP bonus</li>

  <div style="height:10px;"></div>
    
    <li>- #mywin submission 20 XP each</li>
  </ul>

  <a href="https://t.me/tgGbOPvp1p05NjA9" target="_blank"
     style="display:inline-block;margin-top:6px;margin-left:10px;
            background:#007bff;color:#fff;text-decoration:none;
            font-size:12px;padding:3px 8px;border-radius:6px;">
    📸 Submit Now
  </a>

  <hr style="border:none;border-top:1px solid #ddd;margin:10px 0;">

  <ul style="margin:0; padding:0; list-style:none; line-height:1.6;">
    <li>- Weekly Top 10 = Extra Voucher</li>
  </ul>
</div>

<div id="tab-vip" class="tab-panel" style="display:none; text-align:left;">
  <p style="margin-bottom:8px;"><b>VIP Tier 1 (Monthly)</b></p>
  <ul style="margin:0; padding:0; list-style:none; line-height:1.6;">
    <li>- Reach 800 Monthly XP → VIP Tier 1</li>
    <li>- Below 800 at refresh → Back to Normal</li>
    <li>- VIP unlocks Bonus Voucher</li>
  </ul>
</div>
    
     <!-- CLOSE BUTTON -->
    <button id="closeInfoHub"
            style="margin-top:20px;padding:10px 20px;background:#007bff;color:#fff;border:none;border-radius:8px;cursor:pointer;width:100%;">
      Close
    </button>

  </div> <!-- END inner modal card -->
</div>   <!-- END #infoHubModal -->

  <div class="section" id="region-section" style="display: none;">
  <h3>🌍 Select Your Region</h3>
  <select id="region-select">
    <option value="">-- Please choose --</option>
    <option value="Malaysia">🇲🇾 Malaysia</option>
    <option value="Thailand">🇹🇭 Thailand</option>
    <option value="Indonesia">🇮🇩 Indonesia</option>
    <option value="Other">🌐 Other</option>
  </select>
  <button onclick="setRegion()">Save Region</button>
  <p id="region-message" style="color:gray;"></p>
</div>

  <div class="section">
    <h3>✅ Daily Check-in</h3>
    <button onclick="checkIn()">Check In</button>
    <p id="checkin-result"></p>
    <p id="checkin-timer" style="color: gray;"></p>
  </div>

  <div class="section">
    <h3>🔗 Your Referral Link (valid 24h)</h3>
    <button onclick="getReferral()">Generate Link</button>
    <p id="referral-link">Click the button to get your link</p>
    <button onclick="copyReferral()">📋 Copy to clipboard</button>
  </div>

  <div class="section" id="bonus-voucher" style="display: none;">
    <h3>🎁 VIP Bonus Voucher</h3>
    <p id="voucher-code">Coming soon…</p>
    <button onclick="copyVoucherCode()">📋 Copy to clipboard</button>
  </div>
  
  <div class="section" id="voucher-section" style="display:none;">
    <h3>🎟️ Campaign Rewards</h3>
    <div id="voucher-cards"></div>
  </div>
  
  <div class="section">
    <h3>🏆 Weekly Leaderboard</h3>
    <button onclick="loadLeaderboard()">View Leaderboard</button>
    <div id="leaderboard-output">Click to load latest rankings...</div>
  </div>
  
  <div class="section" id="admin-panel">
    <h3>⚙️ Admin Panel</h3>
    <button onclick="openAddXP()">➕ Add/Reduce XP</button>
    <button onclick="viewJoinRequests()">📥 View Join Requests</button>
    <button onclick="loadPreviousLeaderboard()">🏆 View Past Leaderboard</button>
    <button onclick="openVoucherModal()">🎁 Create Bonus Voucher</button>

  
    <div id="adm_drop_container" style="margin-top:18px; text-align:left;">
      <h4 style="margin-bottom:8px;">🎟️ Voucher Drops</h4>
      <p style="margin:4px 0 12px 0; color:#666; font-size:13px;">All times are saved in UTC and shown in Kuala Lumpur (UTC+08:00).</p>

      <div style="background:#fff; border:1px solid #ddd; border-radius:8px; padding:12px; margin-bottom:16px;">
        <h5 style="margin:0 0 10px 0;">➕ Create Drop</h5>
        <div style="display:flex; flex-wrap:wrap; gap:10px;">
          <input id="adm_name" type="text" placeholder="Campaign name" style="flex:1 1 220px; padding:8px; border-radius:6px; border:1px solid #ccc;">
          <input id="adm_pri" type="number" placeholder="Priority (higher = top)" style="flex:1 1 160px; padding:8px; border-radius:6px; border:1px solid #ccc;">
          <label style="flex:1 1 200px; font-size:12px; color:#555;">Start (KL)
            <input id="adm_starts" type="datetime-local" style="width:100%; padding:8px; border-radius:6px; border:1px solid #ccc;">
          </label>
          <label style="flex:1 1 200px; font-size:12px; color:#555;">End (KL)
            <input id="adm_ends" type="datetime-local" style="width:100%; padding:8px; border-radius:6px; border:1px solid #ccc;">
          </label>
          <label style="flex:1 1 200px; font-size:12px; color:#555;">Type
            <select id="adm_type" style="width:100%; padding:8px; border-radius:6px; border:1px solid #ccc;">
              <option value="personalised">Personalised</option>
              <option value="pooled">Pooled</option>
            </select>
          </label>
        </div>

        <div id="adm_personalised" style="margin-top:12px;">
          <p style="margin:0 0 6px 0; font-size:13px; color:#555;">Paste <code>@username,code</code> per line or import CSV:</p>
          <textarea id="adm_pairs_text" rows="6" placeholder="@player1, CODE123" style="width:100%; padding:8px; border-radius:6px; border:1px solid #ccc; font-family:monospace;"></textarea>
          <div style="display:flex; gap:8px; align-items:center; margin-top:6px;">
            <input id="adm_csv_pairs" type="file" accept=".csv,.txt" style="flex:1;">
            <button id="adm_parse_pairs_btn" type="button">Import CSV</button>
          </div>
        </div>

        <div id="adm_pooled" style="margin-top:12px; display:none;">
          <p style="margin:0 0 6px 0; font-size:13px; color:#555;">Paste one voucher code per line or import CSV. Leave whitelist empty for public pool.</p>
          <textarea id="adm_codes_text" rows="6" placeholder="CODE123" style="width:100%; padding:8px; border-radius:6px; border:1px solid #ccc; font-family:monospace;"></textarea>
          <div style="display:flex; gap:8px; align-items:center; margin-top:6px;">
            <input id="adm_csv_codes" type="file" accept=".csv,.txt" style="flex:1;">
            <button id="adm_parse_codes_btn" type="button">Import CSV</button>
          </div>
          <textarea id="adm_wl_text" rows="3" placeholder="Whitelist usernames (optional)" style="width:100%; margin-top:8px; padding:8px; border-radius:6px; border:1px solid #ccc; font-family:monospace;"></textarea>
        </div>

        <button id="adm_create_btn" type="button" style="margin-top:12px;">Create Drop</button>
      </div>

      <div style="background:#fff; border:1px solid #ddd; border-radius:8px; padding:12px; margin-bottom:16px;">
        <h5 style="margin:0 0 10px 0;">📥 Add to Existing Drop</h5>
        <div style="display:flex; flex-wrap:wrap; gap:10px;">
          <input id="adm_add_drop_id" type="text" placeholder="Drop ID" style="flex:1 1 200px; padding:8px; border-radius:6px; border:1px solid #ccc;">
          <label style="flex:1 1 160px; font-size:12px; color:#555;">Data type
            <select id="adm_add_kind" style="width:100%; padding:8px; border-radius:6px; border:1px solid #ccc;">
              <option value="personalised">Personalised assignments</option>
              <option value="pooled">Pooled codes</option>
            </select>
          </label>
        </div>
        <textarea id="adm_add_text" rows="6" placeholder="Paste data matching the selected type" style="width:100%; margin-top:10px; padding:8px; border-radius:6px; border:1px solid #ccc; font-family:monospace;"></textarea>
        <div style="display:flex; gap:8px; align-items:center; margin-top:6px;">
          <input id="adm_add_csv" type="file" accept=".csv,.txt" style="flex:1;">
          <button id="adm_add_parse_btn" type="button">Import CSV</button>
        </div>
        <button id="adm_add_btn" type="button" style="margin-top:12px;">Add Data</button>
      </div>

      <div style="overflow-x:auto;">
        <table id="adm_table" style="width:100%; border-collapse:collapse; font-size:13px;">
          <thead>
            <tr style="background:#f7f7f7;">
              <th style="text-align:left; padding:6px;">Name</th>
              <th style="padding:6px;">Type</th>
              <th style="padding:6px;">Status</th>
              <th style="padding:6px;">Window (KL)</th>
              <th style="padding:6px;">Stats</th>
              <th style="padding:6px;">Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr><td colspan="6" style="padding:6px;">Loading…</td></tr>
          </tbody>
        </table>
    </div>
  </div>

  </div> <!-- end admin-panel section -->

  <!-- XP Modal -->
  <div id="xp-modal" class="modal">
    <div class="modal-content">
      <h3>Adjust XP</h3>
      <input id="xp-user" type="text" placeholder="@username">
      <input id="xp-amount" type="number" placeholder="Amount (/-)">
      <button onclick="submitXPChange()">Submit</button>
      <button onclick="closeXPModal()">Cancel</button>
    </div>
  </div>

  <!-- Voucher Modal -->
<div id="voucher-modal" class="modal">
  <div class="modal-content">
    <h3>Create Bonus Voucher</h3>
    <input id="voucher-code-input" type="text" placeholder="Voucher Code">
    <input id="voucher-expiry-input" type="datetime-local" placeholder="Start Time">
    <button onclick="submitVoucher()">Create</button>
    <button onclick="closeVoucherModal()">Cancel</button>
  </div>
</div>

<script>
/** Minimal qs replacement (no external lib needed) */
window.qs = {
  parse: (search, opts = {}) => {
    const s = (opts.ignoreQueryPrefix && search.startsWith("?")) ? search.slice(1) : search;
    const sp = new URLSearchParams(s);
    return Object.fromEntries(sp.entries());
  },
  stringify: (obj = {}) => {
    const sp = new URLSearchParams();
    for (const [k, v] of Object.entries(obj)) {
      if (v !== undefined && v !== null) sp.append(k, String(v));
    }
    return sp.toString();
  },
  get: (key, search = location.search) => {
    const s = typeof search === "string" ? search : String(search || "");
    const sp = new URLSearchParams(s.startsWith("?") ? s : `?${s}`);
    return sp.get(key);
  }, 
  has: (key, search = location.search) => {
    const s = typeof search === "string" ? search : String(search || "");
    const sp = new URLSearchParams(s.startsWith("?") ? s : `?${s}`);
    return sp.has(key);
  }
};
</script>
  
<script>
(function () {
  const btn = document.getElementById("setAdminSecretBtn");
  if (!btn) return;
  btn.addEventListener("click", () => {
    const val = prompt("Enter admin secret:");
    if (!val) return;
    try { localStorage.setItem("X-Admin-Secret", val.trim()); } catch {}
    alert("Saved. Reloading…");
    location.reload();
  });
})();
</script>
  
<script>
function getAdminSecret() {
  const sp = new URLSearchParams(location.search);
  const param = (sp.get("admin_secret") || "").trim();
  if (param) {
    try { localStorage.setItem("X-Admin-Secret", param); } catch {}
    // 🔒 Remove it from the URL immediately
    try {
      const url = new URL(location.href);
      url.searchParams.delete("admin_secret");
      history.replaceState(null, "", url.toString());
    } catch {}
    return param;
  }
  try { return localStorage.getItem("X-Admin-Secret") || ""; } catch { return ""; }
}
</script>

  
  <script>
let CURRENT_USERNAME = window.CURRENT_USERNAME || "";
try {
  if (window.Telegram?.WebApp?.initDataUnsafe?.user?.username) {
    CURRENT_USERNAME = Telegram.WebApp.initDataUnsafe.user.username || CURRENT_USERNAME;
  }
} catch (_) {}
if (!CURRENT_USERNAME) {
  const qs = new URLSearchParams(location.search);
  CURRENT_USERNAME = qs.get("username") || "";
}
</script>

  <script>
const tg = window.Telegram?.WebApp;

const V2 = "/v2";
let latestInitData = "";

function getLatestInitData(candidate = "") {
  if (typeof candidate === "string" && candidate.length) {
    latestInitData = candidate;
    return latestInitData;
  }
  if (latestInitData) {
    return latestInitData;
  }
  const qsInit = new URLSearchParams(location.search).get("init_data") || "";
  if (qsInit) {
    latestInitData = qsInit;
  }
  return latestInitData;
}

async function waitForInitData(timeoutMs = 8000, intervalMs = 50) {
  const qs = new URLSearchParams(location.search);
  const deadline = Date.now() + timeoutMs;

  while (Date.now() < deadline) {
    const candidate =
      (typeof tg?.initData === "string" && tg.initData.length ? tg.initData : "") ||
      (typeof window.Telegram?.WebApp?.initData === "string" && window.Telegram.WebApp.initData.length
        ? window.Telegram.WebApp.initData
        : "") ||
      qs.get("init_data") ||
      "";

    const stored = getLatestInitData(candidate);
    if (stored) {
      return stored;
    }

    await new Promise((resolve) => setTimeout(resolve, intervalMs));
  }

  return getLatestInitData("");
}

function v2Headers(extras = {}, initDataOverride = "") {
  const h = { "Content-Type": "application/json", ...extras };
  const urlQS = new URLSearchParams(location.search);

  // Grab init_data fresh each call (safer than capturing once)
  const candidateInitData =
    (typeof initDataOverride === "string" && initDataOverride.length ? initDataOverride : "") ||
    (typeof tg?.initData === "string" && tg.initData.length ? tg.initData : "") ||
    (typeof window.Telegram?.WebApp?.initData === "string" && window.Telegram.WebApp.initData.length
      ? window.Telegram.WebApp.initData
      : "") ||
    urlQS.get("init_data") ||
    "";

  const initDataRaw = getLatestInitData(candidateInitData);

  if (initDataRaw) {
    // Send both header names; some servers might read one or the other.
    h["X-Telegram-Init-Data"] = initDataRaw;
    h["X-Telegram-Init"] = initDataRaw;
  }
  
  const adminSecret = getAdminSecret();

  if (adminSecret) {
    h["X-Admin-Secret"] = adminSecret;
    h["Authorization"] = `Bearer ${adminSecret}`;
  }  
  const usernameHint =
    CURRENT_USERNAME || tg?.initDataUnsafe?.user?.username || urlQS.get("username") || "";
  if (usernameHint) {
    h["X-Admin-Username"] = usernameHint;
  }

  const tgUserId = tg?.initDataUnsafe?.user?.id;
  const userIdFromQS = urlQS.get("user_id") || urlQS.get("id");
  const userIdHint =
    tgUserId !== undefined && tgUserId !== null && tgUserId !== ""
      ? tgUserId
      : userIdFromQS || "";
  if (userIdHint) {
    h["X-Admin-User-Id"] = String(userIdHint);
  }

  return h;
}

// --- Admin helper UI: clear admin mode quickly to hide history ---
(function addAdminClearButton(){
  try {
    const bar = document.createElement("div");
    bar.style.cssText = "margin:8px 0; display:flex; gap:8px; align-items:center;";
    const btn = document.createElement("button");
    btn.textContent = "Clear Admin Mode";
    btn.style.cssText = "padding:6px 10px; border:1px solid #ddd; background:#fff; border-radius:8px; cursor:pointer;";
    btn.onclick = () => {
      try { localStorage.removeItem('X-Admin-Secret'); } catch {}
      alert("Admin mode cleared. Reloading…");
      location.reload();
    };
    // Only render if currently in admin mode
    const hasAdmin = !!getAdminSecret();
    if (hasAdmin) {
      bar.appendChild(btn);
      const target = document.querySelector("h2") || document.body;
      target.parentNode.insertBefore(bar, target.nextSibling);
    }
  } catch {}
})();

// If the server rejects init_data (token rotated), show a gentle tip
function friendlyAuthFail(el) {
  if (!el) return;
  el.innerHTML = `
    <div style="padding:10px;background:#fff3f3;border:1px solid #ffd6d6;border-radius:8px;">
      <b>Coming Soon</b><br/>
    </div>`;
}

async function v2Fetch(path, options = {}) {
  const { headers: extraHeaders, ...rest } = options || {};
  let initDataRaw = await waitForInitData();
  let headers = v2Headers(extraHeaders || {}, initDataRaw);

  let res = await fetch(path, { ...rest, headers });
  if (res.status === 401) {
    // retry once in case initData arrived a moment later
    initDataRaw = await waitForInitData(3000);
    headers = v2Headers(extraHeaders || {}, initDataRaw);
    res = await fetch(path, { ...rest, headers });
    // No success? leave to caller to render a friendly hint
  }
  return res;
}
function splitList(text) {
  // split by any whitespace, comma, or semicolon (collapse repeats)
  return (text || "").split(/[\s,;]+/).map(x => x.trim()).filter(Boolean);
}

function fmtKL(iso) {
 if (!iso) return "";
 try {
   return new Date(iso).toLocaleString("en-MY", {
     timeZone: "Asia/Kuala_Lumpur",
     day: "2-digit", month: "2-digit", year: "numeric",
     hour: "2-digit", minute: "2-digit", second: "2-digit",
     hour12: true
   });
 } catch { return String(iso); }
}
    
function toKLStringFromNative(value) {
  // value looks like: "YYYY-MM-DDTHH:MM"
  if (!/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}$/.test(value || "")) return "";
  const [d, t] = value.split("T");
  return `${d} ${t}:00`; // "YYYY-MM-DD HH:MM:SS" (interpreted as KL local by backend)
}

const admTypeEl = document.getElementById("adm_type");
if (admTypeEl) {
  admTypeEl.addEventListener("change", (e) => {
    const mode = e.target.value;
    const personalised = document.getElementById("adm_personalised");
    const pooled = document.getElementById("adm_pooled");
    if (personalised) personalised.style.display = mode === "personalised" ? "block" : "none";
    if (pooled) pooled.style.display = mode === "pooled" ? "block" : "none";
  });
}
    
async function adm_list() {
  const tbody = document.querySelector("#adm_table tbody");
  if (!tbody) return;
  tbody.innerHTML = `<tr><td colspan="6" style="padding:6px;">Loading…</td></tr>`;

  try {
    const s = getAdminSecret();
    const tail = s ? `?admin_secret=${encodeURIComponent(s)}` : "";
    const res = await v2Fetch(`${V2}/admin/drops_v2${tail}`);
    if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
    const data = await res.json();
    if (data.status !== "ok") throw new Error(JSON.stringify(data));

    tbody.innerHTML = "";
    (data.items || []).forEach((d) => {
      const id = d.dropId || d.id || d._id; // ✅ fallback
      const stats = d.type === "pooled"
        ? `${d.codesFree}/${d.codesTotal} free`
        : `${d.claimed}/${d.assigned} claimed`;

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td style="text-align:left; padding:6px;">${d.name} <span style="font-size:12px;color:#666;">[${d.priority}]</span></td>
        <td>${d.type}</td>
        <td>${d.status}</td>
        <td>${fmtKL(d.startsAt)} → ${fmtKL(d.endsAt)}</td>
        <td>${stats}</td>
        <td>
          <button data-op="start_now" data-id="${id}">Start</button>
          <button data-op="pause"     data-id="${id}">Pause</button>
          <button data-op="end_now"   data-id="${id}">End</button>
        </td>`;
      tbody.appendChild(tr);
    });

    if (!tbody.children.length) {
      tbody.innerHTML = `<tr><td colspan="6" style="padding:6px;">No drops found.</td></tr>`;
    }
  } catch (e) {
    tbody.innerHTML = `<tr><td colspan="6" style="padding:6px;">Voucher endpoint error: ${e.message}</td></tr>`;
  }
}

const admCreateBtn = document.getElementById("adm_create_btn");
if (admCreateBtn) admCreateBtn.onclick = adm_create;
    
async function adm_create() {
  const typeEl = document.querySelector("#adm_type");
  if (!typeEl) return;
  const type = typeEl.value;
  const payload = {
    type,
    name: document.querySelector("#adm_name").value.trim(),
    startsAtLocal: toKLStringFromNative(document.querySelector("#adm_starts").value.trim()),
    priority: Number(document.querySelector("#adm_pri").value || 100),
  };
  
  const endsValue = (document.querySelector("#adm_ends")?.value || "").trim();
  const endsAtLocal = toKLStringFromNative(endsValue);
  if (endsAtLocal) {
    payload.endsAtLocal = endsAtLocal;
  }

  if (!payload.name || !payload.startsAtLocal) {
    alert("Name and Start Time are required."); return;
  }

  if (type === "personalised") {
    const lines = (document.querySelector("#adm_pairs_text").value || "")
      .split(/\r?\n/).map(x => x.trim()).filter(Boolean);
    const assignments = lines.map(line => {
      const [u, c] = line.split(/[,\t]/).map(s => s?.trim());
      return u && c ? { username: u, code: c } : null;
    }).filter(Boolean);
    if (!assignments.length) { alert("Please provide username,code pairs."); return; }
    payload.assignments = assignments;
  } else {
    const codes = (document.querySelector("#adm_codes_text").value || "")
      .split(/\r?\n/).map(x => x.trim()).filter(Boolean);
    if (!codes.length) { alert("Please provide codes."); return; }
    payload.codes = codes;
    const wl = splitList(document.querySelector("#adm_wl_text").value);
    if (wl.length) payload.whitelistUsernames = wl;
  }

  try {
  const s = getAdminSecret();
  const tail = s ? `?admin_secret=${encodeURIComponent(s)}` : "";
  const res = await v2Fetch(`${V2}/admin/drops${tail}`, {      
    method: "POST",
    body: JSON.stringify(payload)
    });

    const data = await res.json();
    if (!res.ok || data.status !== "ok") throw new Error(JSON.stringify(data));
    alert(`Created drop: ${data.dropId}`);
    adm_list();
  } catch (e) {
    alert(`Create failed: ${e.message}`);
  }
}

const admAddParseBtn = document.getElementById("adm_add_parse_btn");
if (admAddParseBtn) admAddParseBtn.onclick = () => {
  const f = document.getElementById("adm_add_csv")?.files?.[0];
  if (!f) return;
  const reader = new FileReader();
  reader.onload = () => {
    const lines = (reader.result || "").toString().split(/\r?\n/);
    const header = (lines[0] || "").toLowerCase();
    let out = "";
    if (header.includes("username") && header.includes("code")) {
      for (let i = 1; i < lines.length; i++) {
        const [u,c] = (lines[i] || "").split(/,|\t/).map(s => s?.trim());
        if (u && c) out += `${u},${c}\n`;
      }
    } else {
      for (let i = 0; i < lines.length; i++) {
        const c = (lines[i] || "").trim();
        if (c) out += `${c}\n`;
      }
    }
    const target = document.getElementById("adm_add_text");
    if (target) target.value = out.trim();
  };
  reader.readAsText(f);
};

const admAddBtn = document.getElementById("adm_add_btn");
if (admAddBtn) admAddBtn.onclick = async () => {
  const dropId = document.getElementById("adm_add_drop_id")?.value.trim();
  const kind = document.getElementById("adm_add_kind")?.value;
  const raw = document.getElementById("adm_add_text")?.value.trim();
  if (!dropId || !raw) { alert("Drop ID and data are required."); return; }

  let payload = {};
  if (kind === "personalised") {
    const assignments = raw.split(/\r?\n/).map(line => {
      const [u, c] = line.split(/[,\t]/).map(x => x?.trim());
      return u && c ? { username: u, code: c } : null;
    }).filter(Boolean);
    if (!assignments.length) { alert("Provide username,code lines."); return; }
    payload = { type: "personalised", assignments };
  } else {
    const codes = raw.split(/\r?\n/).map(x => x.trim()).filter(Boolean);
    if (!codes.length) { alert("Provide one CODE per line."); return; }
    payload = { type: "pooled", codes };
  }

  try {
    const s = getAdminSecret();
    const tail = s ? `?admin_secret=${encodeURIComponent(s)}` : "";
    const res = await v2Fetch(`${V2}/admin/drops/${dropId}/codes${tail}`, {
      method: "POST",
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    if (!res.ok || data.status !== "ok") throw new Error(JSON.stringify(data));
    alert("Added successfully.");
    adm_list();
  } catch (e) {
    alert(`Add failed: ${e.message}`);
  }
};

// Create Drop: CSV → username,code pairs
const admParsePairsBtn = document.getElementById("adm_parse_pairs_btn");
if (admParsePairsBtn) admParsePairsBtn.onclick = () => {
  const f = document.getElementById("adm_csv_pairs")?.files?.[0];
  if (!f) return;
  const reader = new FileReader();
  reader.onload = () => {
    const lines = (reader.result || "").toString().split(/\r?\n/);
    const header = (lines[0] || "").toLowerCase();
    let out = "";
    if (header.includes("username") && header.includes("code")) {
      for (let i = 1; i < lines.length; i++) {
        const [u, c] = (lines[i] || "").split(/,|\t/).map(s => s?.trim());
        if (u && c) out += `${u},${c}\n`;
      }
    } else {
      for (let i = 0; i < lines.length; i++) {
        const [u, c] = (lines[i] || "").split(/,|\t/).map(s => s?.trim());
        if (u && c) out += `${u},${c}\n`;
      }
    }
    const target = document.getElementById("adm_pairs_text");
    if (target) target.value = out.trim();
  };
  reader.readAsText(f);
};

// Create Drop: CSV → codes (one per line)
const admParseCodesBtn = document.getElementById("adm_parse_codes_btn");
if (admParseCodesBtn) admParseCodesBtn.onclick = () => {
  const f = document.getElementById("adm_csv_codes")?.files?.[0];
  if (!f) return;
  const reader = new FileReader();
  reader.onload = () => {
    const lines = (reader.result || "").toString().split(/\r?\n/).map(l => l.trim()).filter(Boolean);
    // if header exists, try to find a "code" column
    if (lines.length && /code/i.test(lines[0])) {
      const header = lines[0].split(/,|\t/).map(h => h.trim().toLowerCase());
      const idx = header.findIndex(h => /code/.test(h));
      if (idx >= 0) {
        const out = [];
        for (let i = 1; i < lines.length; i) {
          const cols = lines[i].split(/,|\t/).map(c => c.trim());
          if (cols[idx]) out.push(cols[idx]);
        }
        const target = document.getElementById("adm_codes_text");
        if (target) target.value = out.join("\n");
        return;
      }
    }
    const target = document.getElementById("adm_codes_text");
    if (target) target.value = lines.join("\n");  };
  reader.readAsText(f);
};
    
</script>
  <script>
    const API_BASE = "https://apreferralv1.fly.dev";
    const user = tg?.initDataUnsafe?.user || {};
    const userId = user.id;
    const username = user.username || user.first_name || "";
    let regionMsg = ""; 
    let latestReferralLink = "";
    
    if (!userId && !getAdminSecret()) {
        const warn = document.createElement('div');
        warn.style.cssText = "margin:10px 0;padding:10px;background:#fff3f3;border:1px solid #ffd6d6;border-radius:8px;color:#900;";
        warn.innerHTML = "<b>Coming Soon</b><br/>";
        document.body.prepend(warn);
  // Do NOT return; let loadVouchers() run so the section shows an explanation.
      }

        // Countdown
    function startCountdown(nextCheckinTimeISO) {
      const el = document.getElementById("checkin-timer");
      const end = new Date(nextCheckinTimeISO).getTime();
      function update() {
        const now = Date.now();
        const d = end - now;
        if (d <= 0) {
          el.innerText = "🎉 You can check in again now!";
          return;
        }
        const h = Math.floor(d / 3600000);
        const m = Math.floor((d % 3600000) / 60000);
        const sFixed = Math.floor((d % 60000) / 1000);
        el.innerText = `⏳ Next check-in: ${h}h ${m}m ${sFixed}s`;
        setTimeout(update, 1000);
      }
      update();
    }

    async function checkIn() {
      const regionMsg = document.getElementById("region-message").innerText;
      if (regionMsg.includes("⚠️ Please select")) {
        alert("❌ Please select and lock your region before check-in.");
        return;
      }

      try {
        const res = await fetch(`${API_BASE}/api/checkin`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ user_id: userId, username })
        });

        const data = await res.json();

        // ✅ Always show message
        document.getElementById("checkin-result").innerText = data.message || "❌ Check-in failed.";

        // ✅ Start countdown if server returned next_checkin_time
        if (data.next_checkin_time) {
          startCountdown(data.next_checkin_time);
        }

        // ✅ Refresh leaderboard only if success
        if (data.success) {
          loadLeaderboard();
        }

      } catch (err) {
        console.error("Check-in error:", err);
        document.getElementById("checkin-result").innerText = "❌ Error connecting to server.";
      }
    }

    async function getReferral() {
      const display = document.getElementById("referral-link");
      try {
        const res = await fetch(`${API_BASE}/api/referral?user_id=${userId}&username=${username}`);
        const rawText = await res.text();
        let data;
        try {
          data = JSON.parse(rawText);
        } catch {
          display.innerText = "❌ Invalid server response.";
          return;
        }

        const link = data.referral_link;
        if (link) {
          latestReferralLink = link;
          display.innerText = link + "\n👆 Tap 'Copy to Clipboard' to copy";
        } else {
          display.innerText = "❌ Failed to get link.";
        }
      } catch {
        display.innerText = "❌ Error connecting to server.";
      }
    }

    async function copyReferral() {
      if (!latestReferralLink) {
        alert("Please generate your referral link first.");
        return;
      }

      try {
        await navigator.clipboard.writeText(latestReferralLink);
        alert("✅ Referral link copied!");
      } catch {
        alert("❌ Copy failed. Please copy manually.");
      }
    }

async function handleAdminAndVoucher() {
  try {
    const res = await fetch(`${API_BASE}/api/is_admin?user_id=${userId}`);
    const adminData = await res.json();
    const isAdmin = adminData.success && adminData.is_admin;
    const voucherRes = await fetch(`${API_BASE}/api/bonus_voucher?user_id=${userId}`);
    const voucherData = await voucherRes.json();

      if (isAdmin) {
      document.getElementById("admin-panel").style.display = "block";
      document.getElementById("bonus-voucher").style.display = "block";
      document.getElementById("voucher-code").innerText = voucherData.code || "❌ No active voucher currently.";
    } else if (voucherData.code) {
      document.getElementById("bonus-voucher").style.display = "block";
      document.getElementById("voucher-code").innerText = voucherData.code;
    } else {
      document.getElementById("bonus-voucher").style.display = "none";
    }
  } catch (err) {
    console.error("❌ Error checking admin or loading voucher:", err);
  }
}

async function loadVouchers() {
  const section = document.getElementById("voucher-section");
  const wrap = document.getElementById("voucher-cards");
  if (!section || !wrap) return;

  // Always show the section (empty state is informative)
  section.style.display = "block";
  wrap.innerHTML = `<div style="padding:8px;color:#666;">Loading rewards…</div>`;

  try {
    const s = getAdminSecret();
    const tail = s ? `?admin_secret=${encodeURIComponent(s)}` : "";
    const res = await v2Fetch(`${V2}/miniapp/vouchers/visible${tail}`);

    // Show explicit reasons
    if (res.status === 401) {
      friendlyAuthFail(wrap);
      return;
    }

    let data;
    try { data = await res.json(); } catch {
      wrap.innerHTML = `<div style="padding:8px;color:#c00;">Invalid JSON from server.</div>`;
      return;
    }

    const drops = Array.isArray(data?.drops) ? data.drops : [];

    if (!drops.length) {
      // Empty but visible column
      wrap.innerHTML = `
        <div style="padding:10px;background:#f9f9ff;border:1px solid #e6e6ff;border-radius:8px;">
          <b>No active rewards for your account right now.</b><br/>
          If this is a test user, check <i>whitelist / region / start-end time</i> on the drop.
        </div>`;
      return;
    }

    // Render cards
    wrap.innerHTML = "";
    for (const d of drops) {
      const card = document.createElement("div");
      card.style.cssText = "border:1px solid #eee;border-radius:10px;padding:12px;margin:8px 0;background:#fff;";

      const buttonAttrs = [
        'class="claim-btn"',
        'style="margin-top:8px"',
        `data-dropid="${d.dropId}"`
      ];
      if (!d.isActive && !d.adminPreview) buttonAttrs.push("disabled");

      const previewNote = d.adminPreview
        ? `<div style="font-size:12px;color:#b26d00;margin-top:6px;">Admin preview · status: ${d.status || (d.isActive ? "active" : "inactive")}</div>`
        : "";

      const approx = typeof d.remainingApprox !== "undefined"
        ? `<div style="font-size:12px;color:#666;margin-top:6px;">Estimated left: ${d.remainingApprox}</div>`
        : "";

      const codeBlock = d.userClaimed && d.code
        ? `<div class="code" style="margin-top:6px;font-family:monospace;">${d.code}</div>`
        : "";

      const claimedAt = d.userClaimed && d.claimedAt
        ? `<div style="font-size:12px;color:#666;margin-top:4px;">Claimed: ${fmtKL(d.claimedAt)}</div>`
        : "";

      card.innerHTML = `
        <div><b>${d.name}</b> <span style="font-size:12px;color:#666;">(${d.type})</span></div>
        <div style="font-size:12px;color:#666;margin-top:4px;">${fmtKL(d.startsAt)} → ${fmtKL(d.endsAt)}</div>
        ${previewNote}
        ${approx}
        <button ${buttonAttrs.join(' ')}>
          ${d.userClaimed ? "View Code" : (d.isActive ? "Claim" : "Not Active")}
        </button>
        ${codeBlock}
        ${claimedAt}
      `;
      wrap.appendChild(card);
    }
  } catch (e) {
    wrap.innerHTML = `
      <div style="padding:10px;background:#fff3f3;border:1px solid #ffd6d6;border-radius:8px;">
        Error loading rewards: ${e?.message || e}
      </div>`;
  }
}
// =====================================
// Admin table actions (start/pause/end)
// =====================================
document.addEventListener("click", async (e) => {
  const btn = e.target.closest("button[data-op][data-id]");
  if (!btn) return;

  const dropId = btn.getAttribute("data-id");
  if (!dropId) { alert("No dropId on this row."); return; }

  const op = btn.getAttribute("data-op");

  try {
    const s = getAdminSecret();
    const tail = s ? `?admin_secret=${encodeURIComponent(s)}` : "";

    const res = await v2Fetch(`${V2}/admin/drops/${dropId}/actions${tail}`, {
      method: "POST",
      body: JSON.stringify({ op })
    });

    let payload = null;
    try { payload = await res.json(); } catch {}

    if (res.status === 401) {
      alert("Not authorized (401). Check ADMIN_PANEL_SECRET / admin allowlist.");
      return;
    }
    if (!res.ok || (payload && payload.status !== "ok")) {
      throw new Error(payload?.error || `HTTP ${res.status}`);
    }
    adm_list && adm_list(); // refresh list
  } catch (err) {
    alert(`Action failed: ${err.message}`);
  }
});
    
// ====================
// Claim / View code
// ====================
document.addEventListener("click", async (e) => {
  const claimBtn = e.target.closest("button[data-dropid],button[data-claim]");
  if (!claimBtn) return;

  // Support both attribute names (your old/new markup)
  const dropId = claimBtn.getAttribute("data-dropid") || claimBtn.getAttribute("data-claim");
  if (!dropId) return;

  try {
    const res = await v2Fetch(`${V2}/miniapp/vouchers/claim`, {
      method: "POST",
      body: JSON.stringify({
        dropId,
        init_data: getLatestInitData() || (tg?.initData || "")
      })
    });
    
    let out = null;
    try { out = await res.json(); } catch { /* ignore */ }

    if (res.status === 401) {
      alert("Not authorized (401). Open inside Telegram WebApp or pass init_data correctly.");
      return;
    }
    // accept either {ok:true} or {status:"ok"}
    const ok = res.ok && (out?.ok === true || out?.status === "ok");
    if (!ok) throw new Error(out?.error || out?.code || `HTTP ${res.status}`);

    // Update UI
    claimBtn.textContent = "View Code";
    const codeText = out?.code ? String(out.code) : "(no code)";
    const claimedAt = out?.claimedAt ? fmtKL(out.claimedAt) : "-";
    alert(`🎟️ Your code: ${codeText}\nClaimed at: ${claimedAt}`);

    // If a code isn’t already shown in DOM, append it
    if (!claimBtn.nextElementSibling || !claimBtn.nextElementSibling.classList?.contains("code")) {
      const codeEl = document.createElement("div");
      codeEl.className = "code";
      codeEl.style.marginTop = "6px";
      codeEl.textContent = codeText;
      claimBtn.insertAdjacentElement("afterend", codeEl);
    }
  } catch (err) {
    alert(`⚠️ Claim failed: ${err.message}`);
  }
});
    
  async function loadLeaderboard() {
    try {
      const res = await fetch(`${API_BASE}/api/leaderboard?user_id=${userId}&t=${Date.now()}`);
      const data = await res.json();
      const out = document.getElementById("leaderboard-output");
      if (!data.success) throw new Error(data.error);

      const checkin = data.leaderboard.checkin.map((u, i) =>
        `${i + 1}. ${u.username || ''} - ${u.xp} XP`
      ).join("\n");

      const referral = data.leaderboard.referral.map((u, i) =>
        `${i + 1}. ${u.username || ''} - ${u.referrals || 0} Ref`
      ).join("\n");
      
      const myXP = data.user?.xp || 0;
      const myMonthlyXP = data.user?.monthly_xp || 0;
      const myRef = data.user?.referrals || 0;
      const myName = user.username ? `@${user.username}` : (user.first_name || "You");
      
      const myStatus = (data.user && data.user.status) ? data.user.status : "Normal";
      let statusLabel = "🧑 Normal";
      if (myStatus === "VIP1") statusLabel = "👑 VIP1";

      out.innerText = `📊 Your Weekly Stats:
👤 ${myName} - ${myXP} XP | ${myRef} Referrals
📅 Monthly XP: ${myMonthlyXP}
${statusLabel}

⭐ XP Leaderboard:
${checkin}

🔗 Referral Leaderboard:
${referral}`;
    } catch {
      document.getElementById("leaderboard-output").innerText = "❌ Error loading leaderboard.";
    }
  }

async function loadPreviousLeaderboard() {
  try {
    // 1. Get all available weeks
    const weeksRes = await fetch(`${API_BASE}/api/leaderboard/history/weeks`);
    const weeksData = await weeksRes.json();

    if (!weeksData.success || weeksData.weeks.length === 0) {
      document.getElementById("leaderboard-output").innerText =
        "❌ No history available.";
      return;
    }

    // Pick the most recent past week
    const lastWeek = weeksData.weeks[0]; // already sorted DESC in backend

    // 2. Fetch that week's leaderboard
    const res = await fetch(
      `${API_BASE}/api/leaderboard/history/week/${lastWeek.week_start}`
    );
    const data = await res.json();

    if (!data.success || !data.history)
      throw new Error(data.error || "Invalid history data");

    const history = data.history;

    // 3. Format output with fallback fields
    const checkin = (history.checkin || [])
      .map((u, i) => {
        const xp = u.xp ?? u.weekly_xp ?? 0;
        const username = u.username || u.first_name || "Unknown";
        return `${i + 1}. ${username} - ${xp} XP`;
      })
      .join("\n");

    const referral = (history.referral || [])
      .map((u, i) => {
        const refs = u.referrals ?? u.weekly_referral_count ?? 0;
        const username = u.username || u.first_name || "Unknown";
        return `${i + 1}. ${username} - ${refs} Ref`;
      })
      .join("\n");

    document.getElementById("leaderboard-output").innerText = `📅 ${history.week_start} → ${history.week_end}

🔁 Check-in:
${checkin}

🔗 Referrals:
${referral}`;
    
  } catch (err) {
    console.error("History error:", err);
    document.getElementById("leaderboard-output").innerText =
      "❌ Error loading history.";
  }
}

    function openAddXP() {
      document.getElementById("xp-modal").style.display = "flex";
    }

    function closeXPModal() {
      document.getElementById("xp-modal").style.display = "none";
    }

    async function submitXPChange() {
  const input = document.getElementById("xp-user").value.trim();
  const amount = parseInt(document.getElementById("xp-amount").value.trim());

  if (!input || isNaN(amount)) {
    alert("Please enter both @username and amount.");
    return;
  }

  try {
    const res = await fetch(`${API_BASE}/api/add_xp?user_id=${userId}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ user_id: input, xp: amount })
    });
    const data = await res.json();
    alert(data.message || "XP updated.");
    if (data.success) {
      loadLeaderboard();
    }
  } catch (err) {
    alert("❌ Failed to connect to server.");
    console.error("Add XP error:", err);
  }
}

    function copyVoucherCode() {
      const code = document.getElementById("voucher-code").innerText;
      navigator.clipboard.writeText(code)
        .then(() => alert("Voucher code copied!"))
        .catch(() => alert("Failed to copy voucher."));
}
     function openVoucherModal() {
  document.getElementById("voucher-modal").style.display = "flex";
}

function closeVoucherModal() {
  document.getElementById("voucher-modal").style.display = "none";
}

 async function submitVoucher() {
      const code = document.getElementById("voucher-code-input").value.trim();
      const releaseAt = document.getElementById("voucher-expiry-input").value;
      if (!code || !releaseAt) {
        alert("Please enter both voucher code and release time.");
        return;
      }
      try {
        const payload = {
          code,
          release_time: new Date(releaseAt).toISOString().replace(".000Z", "Z")
        };
        const res = await fetch(`${API_BASE}/api/admin/set_bonus?user_id=${userId}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (data.status === "success") {
          alert("✅ Voucher scheduled.");
          closeVoucherModal();
          handleAdminAndVoucher();
        } else {
          alert("❌ " + (data.message || "Failed to schedule voucher."));
        }
      } catch (err) {
        alert("❌ Failed to schedule voucher.");
        console.error("Voucher error:", err);
      }
    }
   
async function checkRegionStatus() {
  try {
    const res = await fetch(`${API_BASE}/api/region-status/${userId}`);
    const data = await res.json();

    if (data.locked) {
        // ✅ Already locked
        document.getElementById("region-section").style.display = "none";
        document.getElementById("region-message").innerText =
          `✅ Region locked: ${data.region}`;
        regionMsg = `✅ Region locked: ${data.region}`;
    } else {
        // ❌ No region yet → must choose
        document.getElementById("region-section").style.display = "block";
        document.getElementById("region-message").innerText =
          "⚠️ Please select your region (only once).";
    }

  } catch (err) {
    console.error("Region check failed:", err);
  }
}

async function setRegion() {
  const region = document.getElementById("region-select").value;
  if (!region) { alert("Please select a region."); return; }

  try {
    const res = await fetch(`${API_BASE}/api/set-region/${userId}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ user_id: userId, region }) // <-- add user_id
    });
    const data = await res.json();

    if (data.success) {
      document.getElementById("region-section").style.display = "none";
      document.getElementById("region-message").innerText =
        `✅ Region locked: ${data.region}`;
      regionMsg = `✅ Region locked: ${data.region}`;
      alert("Region saved and locked!");
    } else {
      alert("❌ " + (data.error || "Failed to set region."));
    }
  } catch (err) {
    alert("❌ Error saving region.");
    console.error("Set region error:", err);
  }
}

    async function viewJoinRequests() {
  try {
    const res = await fetch(`${API_BASE}/api/join_requests?user_id=${userId}`);
    const data = await res.json();
    if (!data.success) throw new Error(data.error || "Failed to load");

    const list = data.requests.map(r => `• @${r.username || r.user_id}`).join("\n");
    alert(list || "No pending join requests.");
  } catch (e) {
    alert("❌ Error loading join requests.");
    console.error(e);
  }
}

async function exportCSV() {
  try {
    const res = await fetch(`${API_BASE}/api/export_csv?user_id=${userId}`);
    const csv = await res.text();
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `users_${new Date().toISOString().slice(0,10)}.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  } catch (e) {
    alert("❌ Error exporting CSV.");
    console.error(e);
  }
}

window.onload = async () => {
  if (tg) { tg.ready(); tg.expand(); }

  const init = await waitForInitData();
  console.log("init_data length:", (init || "").length);

  const hasInit = !!(init && init.length >= 10);
  const isAdminMode = !!getAdminSecret();

  if (!hasInit) {
    // No Telegram context: show Rewards column with guidance
    loadVouchers();          // shows 401 help or empty state
    if (isAdminMode) {
      adm_list();           // allow admin table via admin_secret
    }
    return;                  // ⛔️ do NOT call user endpoints without init
  }

  // ✅ Real Telegram user context
  checkRegionStatus();
  handleAdminAndVoucher();
  loadLeaderboard();

  // v2 features (work both in user & admin mode)
  loadVouchers();
  if (isAdminMode) {
    adm_list();
  }
};
    
// --- Info Hub Modal & Tabs ---
document.addEventListener('DOMContentLoaded', () => {
  const infoHubBtn   = document.getElementById("infoHubBtn");
  const infoHubModal = document.getElementById("infoHubModal");
  const closeInfoHub = document.getElementById("closeInfoHub");

  if (infoHubBtn && infoHubModal && closeInfoHub) {
    infoHubBtn.addEventListener("click", () => (infoHubModal.style.display = "block"));
    closeInfoHub.addEventListener("click", () => (infoHubModal.style.display = "none"));
    window.addEventListener("click", (e) => {
      if (e.target === infoHubModal) infoHubModal.style.display = "none";
    });
  }

  // Tab switching (safe if tabs exist)
  document.querySelectorAll(".tab-btn").forEach((btn) => {
    btn.addEventListener("click", () => {
      document.querySelectorAll(".tab-btn").forEach((b) => b.classList.remove("active"));
      document.querySelectorAll(".tab-panel").forEach((p) => (p.style.display = "none"));
      btn.classList.add("active");
      const pane = document.getElementById(btn.dataset.tab);
      if (pane) pane.style.display = "block";
    });
  });
});

  </script>
</body>
</html>
