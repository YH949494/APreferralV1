<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Referral & Check-in</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {
      background-color: #f4f4f4;
      font-family: 'Arial', sans-serif;
      padding: 20px;
      color: #333;
      font-size: 16px;
    }
    h2, h3 {
      text-align: left;
      font-weight: 600;
    }
    .section {
      background: #ffffff;
      padding: 20px;
      margin: 15px 0;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }
    button {
      background-color: #0088cc;
      color: white;
      padding: 10px 20px;
      font-size: 15px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-family: inherit;
      margin: 5px 0;
    }
    button:hover {
      background-color: #006699;
    }
    #referral-link, #checkin-result, #checkin-timer {
      margin-top: 10px;
      font-size: 15px;
    }
    #leaderboard-output {
      margin-top: 10px;
      font-family: 'Courier New', monospace;
      white-space: pre-wrap;
      background: #f9f9f9;
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #ddd;
      font-size: 13px; /* smaller font size */
      line-height: 1.4; /* optional for tighter spacing */
      overflow-x: auto; /* horizontal scroll if needed */
    }
    #admin-panel {
      display: none;
      background: #fff4e6;
      border: 1px solid #ffcc80;
    }
    #admin-panel h3 {
      color: #d17c00;
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0; top: 0;
      width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.5);
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      width: 300px;
    }
    input[type="text"], input[type="number"] {
      width: 90%;
      padding: 10px;
      margin: 8px 0;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <h2>🎯 Referral & Daily Check-in</h2>

  <div class="section" id="region-section" style="display: none;">
  <h3>🌍 Select Your Region</h3>
  <select id="region-select">
    <option value="">-- Please choose --</option>
    <option value="Malaysia">🇲🇾 Malaysia</option>
    <option value="Thailand">🇹🇭 Thailand</option>
    <option value="Indonesia">🇮🇩 Indonesia</option>
    <option value="Other">🌐 Other</option>
  </select>
  <button onclick="setRegion()">Save Region</button>
  <p id="region-message" style="color:gray;"></p>
</div>

  <div class="section">
    <h3>✅ Daily Check-in</h3>
    <button onclick="checkIn()">Check In</button>
    <p id="checkin-result"></p>
    <p id="checkin-timer" style="color: gray;"></p>
  </div>

  <div class="section">
    <h3>🔗 Your Referral Link (valid 24h)</h3>
    <button onclick="getReferral()">Generate Link</button>
    <p id="referral-link">Click the button to get your link</p>
    <button onclick="copyReferral()">📋 Copy to clipboard</button>
  </div>

  <div class="section" id="bonus-voucher" style="display: none;">
    <h3>🎁 VIP Bonus Voucher</h3>
    <p id="voucher-code">Coming soon…</p>
    <button onclick="copyVoucherCode()">📋 Copy to clipboard</button>
  </div>
  
  <div class="section">
    <h3>🏆 Weekly Leaderboard</h3>
    <button onclick="loadLeaderboard()">View Leaderboard</button>
    <div id="leaderboard-output">Click to load latest rankings...</div>
  </div>

  <div class="section" id="admin-panel">
    <h3>⚙️ Admin Panel</h3>
    <button onclick="openAddXP()">➕ Add/Reduce XP</button>
    <button onclick="viewJoinRequests()">📥 View Join Requests</button>
    <button onclick="loadPreviousLeaderboard()">🏆 View Past Leaderboard</button>
    <button onclick="openVoucherModal()">🎁 Create Bonus Voucher</button>
    <button onclick="exportCSV()">📤 Export CSV</button>
    
  </div>

  <!-- XP Modal -->
  <div id="xp-modal" class="modal">
    <div class="modal-content">
      <h3>Adjust XP</h3>
      <input id="xp-user" type="text" placeholder="@username">
      <input id="xp-amount" type="number" placeholder="Amount (+/-)">
      <button onclick="submitXPChange()">Submit</button>
      <button onclick="closeXPModal()">Cancel</button>
    </div>
  </div>

  <!-- Voucher Modal -->
<div id="voucher-modal" class="modal">
  <div class="modal-content">
    <h3>Create Bonus Voucher</h3>
    <input id="voucher-code-input" type="text" placeholder="Voucher Code">
    <input id="voucher-expiry-input" type="datetime-local" placeholder="Start Time">
    <button onclick="submitVoucher()">Create</button>
    <button onclick="closeVoucherModal()">Cancel</button>
  </div>
</div>
  
  <script>
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();

    const API_BASE = "https://apreferralv1.fly.dev";
    const user = tg.initDataUnsafe?.user || {};
    const userId = user.id;
    let regionMsg = ""; 
    const username = user.username || user.first_name || "";

    if (!userId) {
      document.body.innerHTML = "<p style='color:red;'>❌ User ID not found. Please open this Mini App inside Telegram.</p>";
    }

    let latestReferralLink = "";

    async function checkIn() {
        regionMsg = document.getElementById("region-message").innerText;
        if (regionMsg.includes("⚠️ Please select")) {
          alert("❌ Please select and lock your region before check-in.");
          return;
        }

  try {
    const res = await fetch(`${API_BASE}/api/checkin`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ user_id: userId, username })
    });
    const data = await res.json();
    document.getElementById("checkin-result").innerText = data.message || "Check-in failed.";
    if (data.next_checkin_time) startCountdown(data.next_checkin_time);

    if (data.success) {
      loadLeaderboard();  
    }
  } catch (err) {
    document.getElementById("checkin-result").innerText = "❌ Error connecting to server.";
  }
}
    
    async function getReferral() {
      const display = document.getElementById("referral-link");
      try {
        const res = await fetch(`${API_BASE}/api/referral?user_id=${userId}&username=${username}`);
        const rawText = await res.text();
        let data;
        try {
          data = JSON.parse(rawText);
        } catch {
          display.innerText = "❌ Invalid server response.";
          return;
        }

        const link = data.referral_link;
        if (link) {
          latestReferralLink = link;
          display.innerText = link + "\n👆 Tap 'Copy to Clipboard' to copy";
        } else {
          display.innerText = "❌ Failed to get link.";
        }
      } catch {
        display.innerText = "❌ Error connecting to server.";
      }
    }

    async function copyReferral() {
      if (!latestReferralLink) {
        alert("Please generate your referral link first.");
        return;
      }

      try {
        await navigator.clipboard.writeText(latestReferralLink);
        alert("✅ Referral link copied!");
      } catch {
        alert("❌ Copy failed. Please copy manually.");
      }
    }

    function startCountdown(nextCheckinTimeISO) {
      const el = document.getElementById("checkin-timer");
      const end = new Date(nextCheckinTimeISO).getTime();
      function update() {
        const now = Date.now();
        const d = end - now;
        if (d <= 0) {
          el.innerText = "🎉 You can check in again now!";
          return;
        }
        const h = Math.floor(d / 3600000), m = Math.floor((d % 3600000) / 60000), s = Math.floor((d % 60000) / 1000);
        el.innerText = `⏳ Next check-in: ${h}h ${m}m ${s}s`;
        setTimeout(update, 1000);
      }
      update();
    }

  async function handleAdminAndVoucher() {
    try {
      const res = await fetch(`${API_BASE}/api/is_admin?user_id=${userId}`);
      const adminData = await res.json();
      const isAdmin = adminData.success && adminData.is_admin;

      const voucherRes = await fetch(`${API_BASE}/api/bonus_voucher?user_id=${userId}`);
      const voucherData = await voucherRes.json();

      console.log("isAdmin:", isAdmin);
      console.log("voucherData:", voucherData);
      
      if (isAdmin) {
        // Show admin panel
        document.getElementById("admin-panel").style.display = "block";

        // Always show bonus voucher box to admin
        document.getElementById("bonus-voucher").style.display = "block";
        document.getElementById("voucher-code").innerText = voucherData.code || "❌ No active voucher currently.";
      } else if (voucherData.code) {
        // Normal VIP1 users only see if voucher is active
        document.getElementById("bonus-voucher").style.display = "block";
        document.getElementById("voucher-code").innerText = voucherData.code;
      }

    } catch (err) {
    console.error("❌ Error checking admin or loading voucher:", err);
    }
  }
    
  async function loadLeaderboard() {
    try {
      const res = await fetch(`${API_BASE}/api/leaderboard?user_id=${userId}&t=${Date.now()}`);
      const data = await res.json();
      const out = document.getElementById("leaderboard-output");
      if (!data.success) throw new Error(data.error);

      const checkin = data.leaderboard.checkin.map((u, i) =>
        `${i + 1}. ${u.username || ''} - ${u.xp} XP`
      ).join("\n");

      const referral = data.leaderboard.referral.map((u, i) =>
        `${i + 1}. ${u.username || ''} - ${u.referrals} Ref`
      ).join("\n");

      const myXP = data.user?.xp || 0;
      const myMonthlyXP = data.user?.monthly_xp || 0;
      const myRef = data.user?.referrals || 0;
      const myName = user.username ? `@${user.username}` : (user.first_name || "You");
      
      const myStatus = (data.user && data.user.status) ? data.user.status : "Normal";
      let statusLabel = "🧑 Normal";
      if (myStatus === "VIP1") statusLabel = "👑 VIP1";

      out.innerText =
        `📊 Your Weekly Stats:\n👤 ${myName} - ${myXP} XP | ${myRef} Referrals\n` +
        `📅 Monthly XP: ${myMonthlyXP}\n` +
        `${statusLabel}\n\n` +
        `🔁 Check-in Leaderboard:\n${checkin}\n\n` +
        `🔗 Referral Leaderboard:\n${referral}`;
    } catch {
      document.getElementById("leaderboard-output").innerText = "❌ Error loading leaderboard.";
    }
  }

async function loadPreviousLeaderboard() {
  try {
    // 1. Get all available weeks
    const weeksRes = await fetch(`${API_BASE}/api/leaderboard/history/weeks`);
    const weeksData = await weeksRes.json();

    if (!weeksData.success || weeksData.weeks.length === 0) {
      document.getElementById("leaderboard-output").innerText =
        "❌ No history available.";
      return;
    }

    // Pick the most recent past week
    const lastWeek = weeksData.weeks[0]; // already sorted DESC in backend

    // 2. Fetch that week's leaderboard
    const res = await fetch(
      `${API_BASE}/api/leaderboard/history/week/${lastWeek.week_start}`
    );
    const data = await res.json();

    if (!data.success || !data.history)
      throw new Error(data.error || "Invalid history data");

    const history = data.history;

    // 3. Format output with fallback fields
    const checkin = (history.checkin || [])
      .map((u, i) => {
        const xp = u.xp ?? u.weekly_xp ?? 0;
        const username = u.username || u.first_name || "Unknown";
        return `${i + 1}. ${username} - ${xp} XP`;
      })
      .join("\n");

    const referral = (history.referral || [])
      .map((u, i) => {
        const refs = u.referrals ?? u.weekly_referral_count ?? 0;
        const username = u.username || u.first_name || "Unknown";
        return `${i + 1}. ${username} - ${refs} Ref`;
      })
      .join("\n");

    document.getElementById("leaderboard-output").innerText =
      `📅 ${history.week_start} → ${history.week_end}\n\n` +
      `🔁 Check-in:\n${checkin}\n\n` +
      `🔗 Referrals:\n${referral}`;
  } catch (err) {
    console.error("History error:", err);
    document.getElementById("leaderboard-output").innerText =
      "❌ Error loading history.";
  }
}

    function openAddXP() {
      document.getElementById("xp-modal").style.display = "flex";
    }

    function closeXPModal() {
      document.getElementById("xp-modal").style.display = "none";
    }

    async function submitXPChange() {
      const input = document.getElementById("xp-user").value.trim();
      const amount = parseInt(document.getElementById("xp-amount").value.trim());

      if (!input || isNaN(amount)) {
        alert("Please enter both @username and amount.");
        return;
      }

      try {
        const res = await fetch(`${API_BASE}/api/add_xp`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ user_id: input, xp: amount })
        });
        const data = await res.json();
        alert(data.message || "XP updated.");
        if (data.success) {
          loadLeaderboard();
        }
      } catch (err) {
        alert("❌ Failed to connect to server.");
        console.error("Add XP error:", err);
      }
    }

    function viewJoinRequests() {
      alert("Coming soon: View Join Requests.");
    }

    function exportCSV() {
      alert("Coming soon: Export CSV.");
    }

    function copyVoucherCode() {
      const code = document.getElementById("voucher-code").innerText;
      navigator.clipboard.writeText(code)
        .then(() => alert("Voucher code copied!"))
        .catch(() => alert("Failed to copy voucher."));
}
     function openVoucherModal() {
  document.getElementById("voucher-modal").style.display = "flex";
}

function closeVoucherModal() {
  document.getElementById("voucher-modal").style.display = "none";
}

async function submitVoucher() {
  const code = document.getElementById("voucher-code-input").value.trim();
  const releaseAt = document.getElementById("voucher-expiry-input").value;

  if (!code || !releaseAt) {
    alert("Please enter both voucher code and release time.");
    return;
  }

  try {
    const payload = {
      code,
      release_time: new Date(releaseAt).toISOString().replace(".000Z", "Z")
    };

    const res = await fetch(`${API_BASE}/api/admin/set_bonus`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const data = await res.json();

    alert(data.message || "Voucher scheduled.");
    if (data.status === "success") {
      closeVoucherModal();
      handleAdminAndVoucher(); // refresh bonus section
    }
  } catch (err) {
    alert("❌ Failed to schedule voucher.");
    console.error("Voucher error:", err);
  }
}
   
async function checkRegionStatus() {
  try {
    const res = await fetch(`${API_BASE}/api/region-status/${userId}`);
    const data = await res.json();

    if (data.locked) {
        // ✅ Already locked
        document.getElementById("region-section").style.display = "none";
        document.getElementById("region-message").innerText =
          `✅ Region locked: ${data.region}`;
        regionMsg = `✅ Region locked: ${data.region}`;
    } else {
        // ❌ No region yet → must choose
        document.getElementById("region-section").style.display = "block";
        document.getElementById("region-message").innerText =
          "⚠️ Please select your region (only once).";
    }

  } catch (err) {
    console.error("Region check failed:", err);
  }
}


async function setRegion() {
  const region = document.getElementById("region-select").value;
  if (!region) { alert("Please select a region."); return; }

  try {
    const res = await fetch(`${API_BASE}/api/set-region/${userId}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ user_id: userId, region }) // <-- add user_id
    });
    const data = await res.json();

    if (data.success) {
      document.getElementById("region-section").style.display = "none";
      document.getElementById("region-message").innerText =
        `✅ Region locked: ${data.region}`;
      regionMsg = `✅ Region locked: ${data.region}`;
      alert("Region saved and locked!");
    } else {
      alert("❌ " + (data.error || "Failed to set region."));
    }
  } catch (err) {
    alert("❌ Error saving region.");
    console.error("Set region error:", err);
  }
}
    
    window.onload = () => {
      checkRegionStatus();
      handleAdminAndVoucher();
      loadLeaderboard();  // 👈 This line loads your weekly stats automatically
    };
  </script>
</body>
</html>
