<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Referral & Check-in</title><script src="https://telegram.org/js/telegram-web-app.js"></script><style>body{background-color:#f4f4f4;font-family:'Arial',sans-serif;padding:20px;color:#333;font-size:16px}h2,h3{text-align:left;font-weight:600}.section{background:#fff;padding:20px;margin:15px 0;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,.1)}button{background-color:#0088cc;color:#fff;padding:10px 20px;font-size:15px;border:none;border-radius:6px;cursor:pointer;font-family:inherit;margin:5px 0}button:hover{background-color:#006699}#referral-link,#checkin-result,#checkin-timer{margin-top:10px;font-size:15px}#leaderboard-output{margin-top:10px;font-family:'Courier New',monospace;white-space:pre-wrap;background:#f9f9f9;padding:15px;border-radius:8px;border:1px solid #ddd;font-size:13px;line-height:1.4;overflow-x:auto}#admin-panel{display:none;background:#fff4e6;border:1px solid #ffcc80}#admin-panel h3{color:#d17c00}.modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,.5);justify-content:center;align-items:center}.modal-content{background:#fff;padding:20px;border-radius:10px;text-align:center;width:300px}input[type=text],input[type=number]{width:90%;padding:10px;margin:8px 0;border-radius:6px;border:1px solid #ccc;font-size:14px}</style></head><body>
  <h2>ğŸ¯ Referral & Daily Check-in</h2>

<!-- INFO HUB BUTTON -->
<div class="event-section" style="margin-top:20px;text-align:left;">
  <button id="infoHubBtn"
          style="padding:10px 20px;border:none;border-radius:8px;
                 background:#007bff;color:#fff;font-size:16px;cursor:pointer;">
    ğŸ“¢ Info Hub
  </button>
</div>

<!-- INFO HUB MODAL -->
<div id="infoHubModal"
     style="display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;
            background-color:rgba(0,0,0,0.5);">
  <div style="background:#fff;margin:8% auto;padding:20px;border-radius:12px;width:92%;
              max-width:400px;text-align:left;">
    <h2 style="margin-bottom:15px;">â„¹ï¸ Info Hub</h2>

    <!-- TAB BUTTONS -->
    <div style="display:flex;gap:6px;margin-bottom:10px;">
      <button class="tab-btn active" data-tab="tab-event"
              style="flex:1;padding:8px 10px;border:none;border-radius:6px;background:#007bff;color:#fff;cursor:pointer;">
        ğŸ‰ Event
      </button>
      <button class="tab-btn" data-tab="tab-xp"
              style="flex:1;padding:8px 10px;border:none;border-radius:6px;background:#eaf4ff;color:#007bff;cursor:pointer;">
        â­ XP
      </button>
      <button class="tab-btn" data-tab="tab-vip"
              style="flex:1;padding:8px 10px;border:none;border-radius:6px;background:#eaf4ff;color:#007bff;cursor:pointer;">
        ğŸ‘‘ VIP Tier 1
      </button>
    </div>

    <!-- TAB PANELS -->
    <div id="tab-event" class="tab-panel active">
      <p><b>ğŸ‰ AdvantPlay Community Lucky Draw</b></p>
       <ul style="margin-left:20px; list-style:none; padding:0;">
        <li>ğŸ“… 1â€“31 Oct 2025</li>
        <li>ğŸ iPhone 17 Pro Â· Apple Watch Â· AirPods Â· and more</li>
        <li>ğŸ† Winners announced 7 Nov 2025</li>
      </ul>
      <a href="https://telegra.ph/AdvantPlay-Community-Lucky-Draw-09-22"
         target="_blank"
         style="display:inline-block;margin-top:8px;padding:8px 12px;background:#28a745;
                color:#fff;border-radius:6px;text-decoration:none;font-size:14px;">
        ğŸ“œ View T&C
      </a>
    </div>

    <div id="tab-xp" class="tab-panel" style="display:none;">
      <p><b>â­ How to Earn XP</b></p>
      <ul style="margin-left:20px; list-style:none; padding:0;">
        <li>âœ… Daily Check-in +20 XP</li>
        <li>ğŸ“† Streak bonus 7d +50XP Â· 14d +150XP Â· 28d +300XP</li>
        <li>ğŸ”— Referral +30 XP / friend</li>
        <li>ğŸ¯ 3 successful referrals +200 XP bonus</li>
        <li>ğŸ·ï¸ #mywin submission +20 XP each</li>
      </ul>
      <div id="streak-line" style="font-family:'Courier New',monospace;margin-top:8px;">Loadingâ€¦</div>
      <div id="next-checkin-note" style="font-size:12px;color:#666;margin-top:4px;"></div>
    </div>

    <div id="tab-vip" class="tab-panel" style="display:none; text-align:left;">
  <p><b>ğŸ‘‘ VIP Progress (Monthly)</b></p>

  <div class="progress" style="margin:6px 0;">
    <span id="vip-fill"></span>
  </div>
  <div id="vip-note" style="font-size:12px;color:#666;">0 / 800 XP</div>

  <ul style="margin-left:20px;margin-top:8px;list-style:none;padding:0;">
    <li>â¬†ï¸ Reach 800 Monthly XP â†’ VIP Tier 1</li>
    <li>â¬‡ï¸ Below 800 â†’ Demote to Normal</li>
    <li>ğŸ VIP unlocks Bonus Voucher</li>
    <li>ğŸ† Weekly Top 3 = Extra Voucher</li>
  </ul>
</div>

    <button id="closeInfoHub"
            style="margin-top:20px;padding:10px 20px;background:#007bff;color:#fff;
                   border:none;border-radius:8px;cursor:pointer;width:100%;">
      Close
    </button>
  </div>
</div>


<script>
  const eventBtn = document.getElementById("eventBtn");
  const eventModal = document.getElementById("eventModal");
  const closeEvent = document.getElementById("closeEvent");

  eventBtn.addEventListener("click", () => {
    eventModal.style.display = "block";
  });

  closeEvent.addEventListener("click", () => {
    eventModal.style.display = "none";
  });

  // Close modal if user clicks outside the box
  window.addEventListener("click", (e) => {
    if (e.target === eventModal) {
      eventModal.style.display = "none";
    }
  });
</script>

  <div class="section" id="region-section" style="display: none;">
  <h3>ğŸŒ Select Your Region</h3>
  <select id="region-select">
    <option value="">-- Please choose --</option>
    <option value="Malaysia">ğŸ‡²ğŸ‡¾ Malaysia</option>
    <option value="Thailand">ğŸ‡¹ğŸ‡­ Thailand</option>
    <option value="Indonesia">ğŸ‡®ğŸ‡© Indonesia</option>
    <option value="Other">ğŸŒ Other</option>
  </select>
  <button onclick="setRegion()">Save Region</button>
  <p id="region-message" style="color:gray;"></p>
</div>

  <div class="section">
    <h3>âœ… Daily Check-in</h3>
    <button onclick="checkIn()">Check In</button>
    <p id="checkin-result"></p>
    <p id="checkin-timer" style="color: gray;"></p>
  </div>

  <div class="section">
    <h3>ğŸ”— Your Referral Link (valid 24h)</h3>
    <button onclick="getReferral()">Generate Link</button>
    <p id="referral-link">Click the button to get your link</p>
    <button onclick="copyReferral()">ğŸ“‹ Copy to clipboard</button>
  </div>

  <div class="section" id="bonus-voucher" style="display: none;">
    <h3>ğŸ VIP Bonus Voucher</h3>
    <p id="voucher-code">Coming soonâ€¦</p>
    <button onclick="copyVoucherCode()">ğŸ“‹ Copy to clipboard</button>
  </div>
  
  <div class="section">
    <h3>ğŸ† Weekly Leaderboard</h3>
    <button onclick="loadLeaderboard()">View Leaderboard</button>
    <div id="leaderboard-output">Click to load latest rankings...</div>
  </div>

  <div class="section" id="admin-panel">
    <h3>âš™ï¸ Admin Panel</h3>
    <button onclick="openAddXP()">â• Add/Reduce XP</button>
    <button onclick="viewJoinRequests()">ğŸ“¥ View Join Requests</button>
    <button onclick="loadPreviousLeaderboard()">ğŸ† View Past Leaderboard</button>
    <button onclick="openVoucherModal()">ğŸ Create Bonus Voucher</button>
    <button onclick="exportCSV()">ğŸ“¤ Export CSV</button>
    
  </div>

  <!-- XP Modal -->
  <div id="xp-modal" class="modal">
    <div class="modal-content">
      <h3>Adjust XP</h3>
      <input id="xp-user" type="text" placeholder="@username">
      <input id="xp-amount" type="number" placeholder="Amount (+/-)">
      <button onclick="submitXPChange()">Submit</button>
      <button onclick="closeXPModal()">Cancel</button>
    </div>
  </div>

  <!-- Voucher Modal -->
<div id="voucher-modal" class="modal">
  <div class="modal-content">
    <h3>Create Bonus Voucher</h3>
    <input id="voucher-code-input" type="text" placeholder="Voucher Code">
    <input id="voucher-expiry-input" type="datetime-local" placeholder="Start Time">
    <button onclick="submitVoucher()">Create</button>
    <button onclick="closeVoucherModal()">Cancel</button>
  </div>
</div>
  
  <script>
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();

    const API_BASE = "https://apreferralv1.fly.dev";
    const user = tg.initDataUnsafe?.user || {};
    const userId = user.id;
    const username = user.username || user.first_name || "";
    let regionMsg = ""; 
    let latestReferralLink = "";
    
    if (!userId) {
      document.body.innerHTML = "<p style='color:red;'>âŒ User ID not found. Please open this Mini App inside Telegram.</p>";
    }

        // Countdown
    function startCountdown(nextCheckinTimeISO) {
      const el = document.getElementById("checkin-timer");
      const end = new Date(nextCheckinTimeISO).getTime();
      function update() {
        const now = Date.now();
        const d = end - now;
        if (d <= 0) {
          el.innerText = "ğŸ‰ You can check in again now!";
          return;
        }
        const h = Math.floor(d / 3600000);
        const m = Math.floor((d % 3600000) / 60000);
        const sFixed = Math.floor((d % 60000) / 1000);
        el.innerText = `â³ Next check-in: ${h}h ${m}m ${sFixed}s`;
        setTimeout(update, 1000);
      }
      update();
    }

    async function checkIn() {
      const regionMsg = document.getElementById("region-message").innerText;
      if (regionMsg.includes("âš ï¸ Please select")) {
        alert("âŒ Please select and lock your region before check-in.");
        return;
      }

      try {
        const res = await fetch(`${API_BASE}/api/checkin`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ user_id: userId, username })
        });

        const data = await res.json();

        // âœ… Always show message
        document.getElementById("checkin-result").innerText = data.message || "âŒ Check-in failed.";

        // âœ… Start countdown if server returned next_checkin_time
        if (data.next_checkin_time) {
          startCountdown(data.next_checkin_time);
        }

        // âœ… Refresh leaderboard only if success
        if (data.success) {
          loadLeaderboard();
        }

      } catch (err) {
        console.error("Check-in error:", err);
        document.getElementById("checkin-result").innerText = "âŒ Error connecting to server.";
      }
    }

    async function getReferral() {
      const display = document.getElementById("referral-link");
      try {
        const res = await fetch(`${API_BASE}/api/referral?user_id=${userId}&username=${username}`);
        const rawText = await res.text();
        let data;
        try {
          data = JSON.parse(rawText);
        } catch {
          display.innerText = "âŒ Invalid server response.";
          return;
        }

        const link = data.referral_link;
        if (link) {
          latestReferralLink = link;
          display.innerText = link + "\nğŸ‘† Tap 'Copy to Clipboard' to copy";
        } else {
          display.innerText = "âŒ Failed to get link.";
        }
      } catch {
        display.innerText = "âŒ Error connecting to server.";
      }
    }

    async function copyReferral() {
      if (!latestReferralLink) {
        alert("Please generate your referral link first.");
        return;
      }

      try {
        await navigator.clipboard.writeText(latestReferralLink);
        alert("âœ… Referral link copied!");
      } catch {
        alert("âŒ Copy failed. Please copy manually.");
      }
    }

  async function handleAdminAndVoucher() {
    try {
      const res = await fetch(`${API_BASE}/api/is_admin?user_id=${userId}`);
      const adminData = await res.json();
      const isAdmin = adminData.success && adminData.is_admin;

      const voucherRes = await fetch(`${API_BASE}/api/bonus_voucher?user_id=${userId}`);
      const voucherData = await voucherRes.json();

      console.log("isAdmin:", isAdmin);
      console.log("voucherData:", voucherData);
      
      if (isAdmin) {
        // Show admin panel
        document.getElementById("admin-panel").style.display = "block";

        // Always show bonus voucher box to admin
        document.getElementById("bonus-voucher").style.display = "block";
        document.getElementById("voucher-code").innerText = voucherData.code || "âŒ No active voucher currently.";
      } else if (voucherData.code) {
        // Normal VIP1 users only see if voucher is active
        document.getElementById("bonus-voucher").style.display = "block";
        document.getElementById("voucher-code").innerText = voucherData.code;
      }

    } catch (err) {
    console.error("âŒ Error checking admin or loading voucher:", err);
    }
  }
    
  async function loadLeaderboard() {
    try {
      const res = await fetch(`${API_BASE}/api/leaderboard?user_id=${userId}&t=${Date.now()}`);
      const data = await res.json();
      const out = document.getElementById("leaderboard-output");
      if (!data.success) throw new Error(data.error);

      const checkin = data.leaderboard.checkin.map((u, i) =>
        `${i + 1}. ${u.username || ''} - ${u.xp} XP`
      ).join("\n");

      const referral = data.leaderboard.referral.map((u, i) =>
        `${i + 1}. ${u.username || ''} - ${u.referrals || 0} Ref`
      ).join("\n");
      
      const myXP = data.user?.xp || 0;
      const myMonthlyXP = data.user?.monthly_xp || 0;
      const myRef = data.user?.referrals || 0;
      const myName = user.username ? `@${user.username}` : (user.first_name || "You");
      
      const myStatus = (data.user && data.user.status) ? data.user.status : "Normal";
      let statusLabel = "ğŸ§‘ Normal";
      if (myStatus === "VIP1") statusLabel = "ğŸ‘‘ VIP1";

      out.innerText =
        `ğŸ“Š Your Weekly Stats:\nğŸ‘¤ ${myName} - ${myXP} XP | ${myRef} Referrals\n` +
        `ğŸ“… Monthly XP: ${myMonthlyXP}\n` +
        `${statusLabel}\n\n` +
        `â­ XP Leaderboard:\n${checkin}\n\n` +
        `ğŸ”— Referral Leaderboard:\n${referral}`;
    } catch {
      document.getElementById("leaderboard-output").innerText = "âŒ Error loading leaderboard.";
    }
  }

async function loadPreviousLeaderboard() {
  try {
    // 1. Get all available weeks
    const weeksRes = await fetch(`${API_BASE}/api/leaderboard/history/weeks`);
    const weeksData = await weeksRes.json();

    if (!weeksData.success || weeksData.weeks.length === 0) {
      document.getElementById("leaderboard-output").innerText =
        "âŒ No history available.";
      return;
    }

    // Pick the most recent past week
    const lastWeek = weeksData.weeks[0]; // already sorted DESC in backend

    // 2. Fetch that week's leaderboard
    const res = await fetch(
      `${API_BASE}/api/leaderboard/history/week/${lastWeek.week_start}`
    );
    const data = await res.json();

    if (!data.success || !data.history)
      throw new Error(data.error || "Invalid history data");

    const history = data.history;

    // 3. Format output with fallback fields
    const checkin = (history.checkin || [])
      .map((u, i) => {
        const xp = u.xp ?? u.weekly_xp ?? 0;
        const username = u.username || u.first_name || "Unknown";
        return `${i + 1}. ${username} - ${xp} XP`;
      })
      .join("\n");

    const referral = (history.referral || [])
      .map((u, i) => {
        const refs = u.referrals ?? u.weekly_referral_count ?? 0;
        const username = u.username || u.first_name || "Unknown";
        return `${i + 1}. ${username} - ${refs} Ref`;
      })
      .join("\n");

    document.getElementById("leaderboard-output").innerText =
      `ğŸ“… ${history.week_start} â†’ ${history.week_end}\n\n` +
      `ğŸ” Check-in:\n${checkin}\n\n` +
      `ğŸ”— Referrals:\n${referral}`;
  } catch (err) {
    console.error("History error:", err);
    document.getElementById("leaderboard-output").innerText =
      "âŒ Error loading history.";
  }
}

    function openAddXP() {
      document.getElementById("xp-modal").style.display = "flex";
    }

    function closeXPModal() {
      document.getElementById("xp-modal").style.display = "none";
    }

    async function submitXPChange() {
  const input = document.getElementById("xp-user").value.trim();
  const amount = parseInt(document.getElementById("xp-amount").value.trim());

  if (!input || isNaN(amount)) {
    alert("Please enter both @username and amount.");
    return;
  }

  try {
    const res = await fetch(`${API_BASE}/api/add_xp?user_id=${userId}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ user_id: input, xp: amount })
    });
    const data = await res.json();
    alert(data.message || "XP updated.");
    if (data.success) {
      loadLeaderboard();
    }
  } catch (err) {
    alert("âŒ Failed to connect to server.");
    console.error("Add XP error:", err);
  }
}

    function copyVoucherCode() {
      const code = document.getElementById("voucher-code").innerText;
      navigator.clipboard.writeText(code)
        .then(() => alert("Voucher code copied!"))
        .catch(() => alert("Failed to copy voucher."));
}
     function openVoucherModal() {
  document.getElementById("voucher-modal").style.display = "flex";
}

function closeVoucherModal() {
  document.getElementById("voucher-modal").style.display = "none";
}

 async function submitVoucher() {
      const code = document.getElementById("voucher-code-input").value.trim();
      const releaseAt = document.getElementById("voucher-expiry-input").value;
      if (!code || !releaseAt) {
        alert("Please enter both voucher code and release time.");
        return;
      }
      try {
        const payload = {
          code,
          release_time: new Date(releaseAt).toISOString().replace(".000Z", "Z")
        };
        const res = await fetch(`${API_BASE}/api/admin/set_bonus?user_id=${userId}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (data.status === "success") {
          alert("âœ… Voucher scheduled.");
          closeVoucherModal();
          handleAdminAndVoucher();
        } else {
          alert("âŒ " + (data.message || "Failed to schedule voucher."));
        }
      } catch (err) {
        alert("âŒ Failed to schedule voucher.");
        console.error("Voucher error:", err);
      }
    }
   
async function checkRegionStatus() {
  try {
    const res = await fetch(`${API_BASE}/api/region-status/${userId}`);
    const data = await res.json();

    if (data.locked) {
        // âœ… Already locked
        document.getElementById("region-section").style.display = "none";
        document.getElementById("region-message").innerText =
          `âœ… Region locked: ${data.region}`;
        regionMsg = `âœ… Region locked: ${data.region}`;
    } else {
        // âŒ No region yet â†’ must choose
        document.getElementById("region-section").style.display = "block";
        document.getElementById("region-message").innerText =
          "âš ï¸ Please select your region (only once).";
    }

  } catch (err) {
    console.error("Region check failed:", err);
  }
}

async function setRegion() {
  const region = document.getElementById("region-select").value;
  if (!region) { alert("Please select a region."); return; }

  try {
    const res = await fetch(`${API_BASE}/api/set-region/${userId}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ user_id: userId, region }) // <-- add user_id
    });
    const data = await res.json();

    if (data.success) {
      document.getElementById("region-section").style.display = "none";
      document.getElementById("region-message").innerText =
        `âœ… Region locked: ${data.region}`;
      regionMsg = `âœ… Region locked: ${data.region}`;
      alert("Region saved and locked!");
    } else {
      alert("âŒ " + (data.error || "Failed to set region."));
    }
  } catch (err) {
    alert("âŒ Error saving region.");
    console.error("Set region error:", err);
  }
}

    async function viewJoinRequests() {
  try {
    const res = await fetch(`${API_BASE}/api/join_requests?user_id=${userId}`);
    const data = await res.json();
    if (!data.success) throw new Error(data.error || "Failed to load");

    const list = data.requests.map(r => `â€¢ @${r.username || r.user_id}`).join("\n");
    alert(list || "No pending join requests.");
  } catch (e) {
    alert("âŒ Error loading join requests.");
    console.error(e);
  }
}

async function exportCSV() {
  try {
    const res = await fetch(`${API_BASE}/api/export_csv?user_id=${userId}`);
    const csv = await res.text();
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `users_${new Date().toISOString().slice(0,10)}.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  } catch (e) {
    alert("âŒ Error exporting CSV.");
    console.error(e);
  }
}

    window.onload = () => {
      checkRegionStatus();
      handleAdminAndVoucher();
      loadLeaderboard();  // ğŸ‘ˆ This line loads your weekly stats automatically
    };

// --- Info Hub Modal & Tabs ---
document.addEventListener('DOMContentLoaded', () => {
  const infoHubBtn   = document.getElementById("infoHubBtn");
  const infoHubModal = document.getElementById("infoHubModal");
  const closeInfoHub = document.getElementById("closeInfoHub");

  if (infoHubBtn && infoHubModal && closeInfoHub) {
    infoHubBtn.addEventListener("click", () => (infoHubModal.style.display = "block"));
    closeInfoHub.addEventListener("click", () => (infoHubModal.style.display = "none"));
    window.addEventListener("click", (e) => {
      if (e.target === infoHubModal) infoHubModal.style.display = "none";
    });
  }

  // Tab switching (safe if tabs exist)
  document.querySelectorAll(".tab-btn").forEach((btn) => {
    btn.addEventListener("click", () => {
      document.querySelectorAll(".tab-btn").forEach((b) => b.classList.remove("active"));
      document.querySelectorAll(".tab-panel").forEach((p) => (p.style.display = "none"));
      btn.classList.add("active");
      const pane = document.getElementById(btn.dataset.tab);
      if (pane) pane.style.display = "block";
    });
  });
});

  </script>
</body>
</html>
