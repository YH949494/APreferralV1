<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Referral & Check-in</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {
      background-color: #f4f4f4;
      font-family: Arial, sans-serif;
      padding: 20px;
      color: #333;
    }
    h2 { text-align: center; }
    .section {
      background: white;
      padding: 20px;
      margin: 15px 0;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    button {
      background-color: #0088cc;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    button:hover {
      background-color: #006699;
    }
    #referral-link {
      word-break: break-word;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h2>üéØ Referral & Daily Check-in</h2>

  <div class="section">
    <h3>‚úÖ Daily Check-in</h3>
    <button onclick="checkIn()">Check In</button>
   <p id="checkin-result"></p>
   <p id="checkin-timer" style="color: gray; font-size: 14px;"></p>

  </div>

  <div class="section">
    <h3>üîó Your Referral Link (valid 24h)</h3>
    <button onclick="getReferral()">Generate Link</button>
    <p id="referral-link">Click the button to get your link</p>
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();

    const userId = tg.initDataUnsafe?.user?.id;
    const username = tg.initDataUnsafe?.user?.username || "unknown";

    if (!userId) {
      document.body.innerHTML = "<p style='color:red;'>‚ùå User ID not found. Please open this Mini App inside Telegram.</p>";
    }

    console.log("userId:", userId, "username:", username);

   async function checkIn() {
  try {
    const res = await fetch(`/api/checkin?user_id=${userId}&username=${username}`);
    
    if (!res.ok) {
      throw new Error(`Server responded with status ${res.status}`);
    }

    const data = await res.json();

    document.getElementById("checkin-result").innerText = data.message || "Check-in failed.";

    if (data.next_checkin_time) {
      startCountdown(data.next_checkin_time);
    }

  } catch (err) {
    document.getElementById("checkin-result").innerText = "‚ùå Error connecting to server.";
    console.error("Check-in error:", err);
  }
}

  async function getReferral() {
  try {
    const res = await fetch(`https://apreferralv1.fly.dev/api/referral?user_id=${userId}&username=${username}`);
    
    const text = await res.text(); // get raw text response
    console.log("Raw referral response:", text);

    let data;
    try {
      data = JSON.parse(text);
    } catch (parseErr) {
      document.getElementById("referral-link").innerText = "‚ùå Invalid server response.";
      console.error("JSON parse error:", parseErr);
      return;
    }

    const link = data.referral_link;

    const display = document.getElementById("referral-link");
    if (link) {
      display.innerText = link;
      await navigator.clipboard.writeText(link);
      display.innerText += "\nüìã Copied to clipboard!";
    } else {
      display.innerText = "‚ùå Failed to get link.";
    }
  } catch (err) {
    document.getElementById("referral-link").innerText = "‚ùå Error connecting to server.";
    console.error(err);
  }
}
    function startCountdown(nextCheckinTimeISO) {
  const countdownEl = document.getElementById("checkin-timer");
  const endTime = Date.parse(nextCheckinTimeISO); // UTC

  function updateCountdown() {
    const now = new Date().getTime(); // Local
    const distance = endTime - now;

    if (distance <= 0) {
      countdownEl.innerText = "üéâ You can check in again now!";
      return;
    }

    const totalHours = Math.floor(distance / (1000 * 60 * 60));
    const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((distance % (1000 * 60)) / 1000);

    countdownEl.innerText = `‚è≥ Next check-in in: ${totalHours}h ${minutes}m ${seconds}s`;

    setTimeout(updateCountdown, 1000);
  }

  updateCountdown();
}
  </script>
</body>
</html>
