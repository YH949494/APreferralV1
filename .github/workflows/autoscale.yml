name: Autoscale Fly Web for Voucher Drops

on:
  schedule:
    - cron: "*/1 * * * *"
  workflow_dispatch: {}

jobs:
  scale:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          pip install pymongo

      - name: Install flyctl
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Run autoscaler
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
          FLY_APP_NAME: ${{ secrets.FLY_APP_NAME }}
          MONGO_URL: ${{ secrets.MONGO_URL }}
          BASE_WEB_COUNT: "1"
          PEAK_WEB_COUNT: "5"
          LEAD_MINUTES: "2"
          DURATION_MINUTES: "10"
        run: |
          python autoscale.py
